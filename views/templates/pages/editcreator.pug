extends ../index
block mainContent

	.profile-wrapper
		.save-button#save-button(onclick = 'saveEdits()') save
		.profile-info
			.image
			input.fist-name#first-name(placeholder='First name')
			input.last-name#last-name(placeholder='Last name')
			input.description#user-description(placeholder='User description')
			.location#user-location
				input.country(placeholder='Country')
				input.city(placeholder='City')
			//input#location-search(placeholder = 'Your city')
			.skills#user-skills
				h4.title Skills
				.wrapper
			.projects#user-projects
				h4.title What I have done
				.wrapper
				.add-new(onclick='newProject()') Add

	

	script.
		//AIzaSyB9uz6sZTjEZOIE6Z_GWoXNyxNpsT33v70

		
		var startCountry
		var startCity
		var userSkills
		var saveLocation

		//action-button -> edit or add friend
		firebase.auth().onAuthStateChanged(function(user) {
			firebase.database().ref('users/creators/' + currentUser().uid).once("value", function(snapshot){
				var userData = snapshot.val()
				userSkills = userData.skills

				startCountry = userData.country
				startCity = userData.city

				if(!userData.city || !userData.country){
					$.getJSON("http://freegeoip.net/json/", function (data) {
						var country = data.country_name
						var region = data.region_name

						document.getElementById('user-location').querySelector('.country').value = country
						document.getElementById('user-location').querySelector('.city').value = region

						saveLocation()
						
					});
				}

				//try{

				document.getElementById('first-name').value = userData.firstName
				document.getElementById('last-name').value = userData.lastName
				document.getElementById('user-description').value = userData.description || ''
				document.getElementById('user-location').querySelector('.country').value = userData.country
				document.getElementById('user-location').querySelector('.city').value = userData.city

				saveLocation = function(){

					function capitalizeFirstLetter(string) {
						return string.charAt(0).toUpperCase() + string.slice(1);
					}
					var country = capitalizeFirstLetter(document.getElementById('user-location').querySelector('.country').value.toLowerCase())
					var city = capitalizeFirstLetter(document.getElementById('user-location').querySelector('.city').value.toLowerCase())

					firebase.database().ref('users/creators/' + currentUser().uid).update({
						country: country,
						city: city,
					})

					firebase.database().ref('locations/' + startCountry + '/users/' + currentUser().uid).remove()
					firebase.database().ref('locations/' + country + '/users/' + currentUser().uid).set((new Date).getTime())

					firebase.database().ref('locations/' + startCountry + '/cities/' + startCity + '/' + currentUser().uid).remove()
					firebase.database().ref('locations/' + country + '/cities/' + city + '/' + currentUser().uid).set((new Date).getTime())

					startCountry = country
					startCity = city
				}
			
				

				firebase.database().ref('skills').once("value", function(snapshot){
					var allSkills = snapshot.val()

					Object.values(allSkills).forEach(function(mainSkill, idx){
						var mainSkillId = Object.keys(allSkills)[idx]
						if(userData.skills){
							var userMainSkill = userData.skills[mainSkillId]
						}else{
							var userMainSkill = false
						}
						renderSkill(Object.values(allSkills)[idx].name, mainSkillId, userMainSkill, true)
						Object.values(mainSkill.subSkills).forEach(function(subSkill, idx2){
							var subSkillId = Object.keys(mainSkill.subSkills)[idx2]
							if(userMainSkill){
								var userSubSkill = userData.skills[mainSkillId][subSkillId]
							}else{
								var userSubSkill = false
							}
							
							renderSkill(subSkill.name, subSkillId, userSubSkill, false, mainSkillId)
						})
					})
				})
				//render skills

				function renderSkill(title, id, checked, isMainSkill, mainSkillId){
					var skillDiv = document.createElement('div')
					skillDiv.classList.add('skill')
					document.getElementById('user-skills').querySelector('.wrapper').appendChild(skillDiv)

					var checkmark = document.createElement('input')
					checkmark.type = 'checkbox'
					checkmark.dataset.skillId = id
					checkmark.id = id
					checkmark.dataset.isMainSkill = isMainSkill
					checkmark.dataset.mainSkillId = mainSkillId
					checkmark.classList.add('checkmark')
					checkmark.checked = checked
					if(!isMainSkill){checkmark.classList.add('main-' + mainSkillId)}
					skillDiv.appendChild(checkmark)

					checkmark.onclick = function(el){

						if(el.target.dataset.isMainSkill == 'true'){
							if(!el.target.checked) document.querySelectorAll('.main-' + el.target.dataset.skillId).forEach(function(el2){
								el2.checked = false
							})
							userSkills[el.target.dataset.skillId] = el.target.checked || null
						}else{
							if(!_(el.target.dataset.mainSkillId).checked){
								el.target.checked = false
								return
							}

							if(typeof(userSkills[el.target.dataset.mainSkillId]) == "boolean"){
								userSkills[el.target.dataset.mainSkillId] = {}
							}
							userSkills[el.target.dataset.mainSkillId][el.target.dataset.skillId] = el.target.checked || null

							if(typeof(userSkills[el.target.dataset.mainSkillId]) !== "boolean"){

								var onlyNull = true

								Object.values(userSkills[el.target.dataset.mainSkillId]).forEach(function(val){
									if(val !== null){onlyNull = false}
								})

								if(onlyNull){
									userSkills[el.target.dataset.mainSkillId] = true
								}
							}
						}
						console.log(userSkills)
					}	

					var titleP = document.createElement('p')
					titleP.innerText = title
					titleP.classList.add('skill')
					skillDiv.appendChild(titleP)	
				}

				//render Projects

				if(userData.projects){
					Object.values(userData.projects).forEach(function(project, idx){
						renderProject(project.id, project.title, project.description, project.link)
					})
				}

				//- }catch(e){

				//- }

			})
		})


		function renderProject(id, title, description, link){
			var wrapperDiv = document.createElement('div')
			wrapperDiv.classList.add('skill')
			document.getElementById('user-projects').querySelector('.wrapper').appendChild(wrapperDiv)
			wrapperDiv.dataset.id = id

			var titleDiv = document.createElement('p')
			titleDiv.classList.add('title')
			if(title){titleDiv.innerText = title}
			wrapperDiv.appendChild(titleDiv)

			var descriptionDiv = document.createElement('p')
			descriptionDiv.classList.add('description')
			if(description){descriptionDiv.innerText = description}
			wrapperDiv.appendChild(descriptionDiv)

			var linkEl = document.createElement('p')
			linkEl.classList.add('link')
			if(link){linkEl.innerText = link}
			wrapperDiv.appendChild(linkEl)

			var editEl = document.createElement('div')
			editEl.classList.add('editBtn')
			editEl.innerText = 'Edit'
			wrapperDiv.appendChild(editEl)
			editEl.onclick = function(event){
				var id = event.target.parentElement.dataset.id
				window.location = '/editproject/' + id
			}
		}

		function newProject(){
			var projectId = (new Date()).getTime()

			firebase.database().ref('users/creators/' + currentUser().uid + '/projects/' + projectId).set({
				title: "",
				description: "",
				link: ""
			}).then(function(){
				window.location = '/editproject/' + projectId
			})
		}

		function saveEdits(){
			firebase.database().ref('users/creators/' + currentUser().uid).update({
				firstName: _('first-name').value,
				lastName: _('last-name').value,
				description: _('user-description').value,
			}).then(function(){
				firebase.database().ref('users/creators/' + currentUser().uid + '/skills').set(userSkills).then(function(){
					popUp('Changes saved.')
				})

			})

			if(startCity != _('user-location').querySelector('.city').value || startCountry !== _('user-location').querySelector('.country').value){
				saveLocation()
			}
		}

	//- script.
	//- 	function activatePlaceSearch(){
	//- 		var input = _("location-search")
	//- 		 var options = {
	//- 			types: ['(cities)'],
	//- 		 };
	//- 		var autocomplete = new google.maps.places.Autocomplete(input)

	//- 		google.maps.event.addListener(autocomplete, 'place_changed', function() {
	//- 			var place = autocomplete.getPlace();
	//- 			for (var i = 0; i < place.address_components.length; i++) {
	//- 				for (var j = 0; j < place.address_components[i].types.length; j++) {
	//- 					if (place.address_components[i].types[j] == "postal_code") {
	//- 					document.getElementById('postal_code').innerHTML = place.address_components[i].long_name;

	//- 					}
	//- 				}
	//- 			}
	//- 		})
	//- 	}

	//- script(type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9uz6sZTjEZOIE6Z_GWoXNyxNpsT33v70&libraries=places&callback=activatePlaceSearch")


		



		